<!DOCTYPE html>

<html lang="en">
<head>
  <link href=
    "//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="../stylesheets/style.css">

<script type="text/javascript">

  var activeGroup;
  var lastMessage;

  function retrieveGroups() {
    $.getJSON('/groupme/groups', function(elements) {
      console.log(elements);
      console.log(elements.length);
      if (elements != undefined) {
        var htmlOut = "";
        activeGroup = elements[0].id;
        for (var i=0; i<elements.length; i++) {
          htmlOut += "<div class='conversationBox' id='" + elements[i].id + "'onClick='makeActive(" + elements[i].id + ")'>" + elements[i].conversationName + "</div>";
        }
        $("#content").html(htmlOut);
      } else {
        var htmlOut = "No conversations found."
        $("#content").html(htmlOut);
      }
    });
  }

  function makeActive(i) {
    $('#' + activeGroup).removeClass('active');
    activeGroup = i;
    $('#' + activeGroup).addClass('active');
    console.log(activeGroup);
    retrieveMessages();
  }

  function checkActive() {
    return activeGroup;
  }

  function sendMessage() {
    if (activeGroup != null) {
      var content = $("#messageContent").val();
      var id = activeGroup; //fix this jawn
      var data = {message: content, group_id: id};
      $.ajax({
        type: "POST",
        url: 'http://localhost:3000/groupme/send/',
        data: data
      });
      console.log('it happened');
      $("#messageContent").val("");
      setTimeout(function(){retrieveMessages()}, 100);
    } else {
      console.log("Pick a conversation.");
    }
    return false;
  }

  function retrieveMessages() {
    var id = activeGroup;
    $.get('http://localhost:3000/groupme/messages?group_id=' + id, function(response) {
      console.log(response);
      lastMessage = response[response.length-1].id;
      var htmlOut = "";
      for (var i = 0; i < response.length; i++) {

        //Case 1: Just text
        if (response[i].text != null && response[i].image == null) {
          htmlOut += "<div class = 'one_message'> <div class='avatar-box'><img class='avatar' src='" + response[i].pic + "'></div> <strong>" + response[i].name + ": </strong>" + response[i].text + "<br><div align='right'><em>" + response[i].like_count + " favorites</em></div></div>";
        //Case 2: Just image
        } else if (response[i].text == null && response[i].image != null) {
          htmlOut += "<div class = 'one_message'> <div class='avatar-box'><img class='avatar' src='" + response[i].pic + "'></div> <strong>" + response[i].name + ": </strong><br><a href='" + response[i].image + "'><img width='150px' height='auto' src='" + response[i].image + "'></a><br><div align='right'><em>" + response[i].like_count + " favorites</em></div></div>";
        //Case 3: Image and text
        } else if (response[i].text != null && response[i].image != null) {
          htmlOut += "<div class = 'one_message'> <div class='avatar-box'><img class='avatar' src='" + response[i].pic + "'></div> <strong>" + response[i].name + ": </strong>" + response[i].text + "<br><a href='" + response[i].image + "'><img width='150px' height='auto' src='" + response[i].image + "'></a><br><div align='right'><em>" + response[i].like_count + " favorites</em></div></div>";
        //Case 4: Bad things happened.
        } else {
          console.log("Something went wrong with a message.");
        }
      }

      $("#lots_of_messages").html(htmlOut);
    });
    return false;
  }

  function loadMore() {
    var group_id = activeGroup;
    var last_message = lastMessage;
    $.get('http://localhost:3000/groupme/moremessages?group_id=' + group_id + '&last_message=' + last_message, function(response) {
      if (response.length == 0) return false;
      lastMessage = response[response.length-1].id;
      var htmlOut = "";
      for (var i = 0; i < response.length; i++) {

        //Case 1: Just text
        if (response[i].text != null && response[i].image == null) {
          htmlOut += "<div class = 'one_message'> <div class='avatar-box'><img class='avatar' src='" + response[i].pic + "'></div> <strong>" + response[i].name + ": </strong>" + response[i].text + "<br><div align='right'><em>" + response[i].like_count + " favorites</em></div></div>";
        //Case 2: Just image
        } else if (response[i].text == null && response[i].image != null) {
          htmlOut += "<div class = 'one_message'> <div class='avatar-box'><img class='avatar' src='" + response[i].pic + "'></div> <strong>" + response[i].name + ": </strong><br><a href='" + response[i].image + "'><img width='150px' height='auto' src='" + response[i].image + "'></a><br><div align='right'><em>" + response[i].like_count + " favorites</em></div></div>";
        //Case 3: Image and text
        } else if (response[i].text != null && response[i].image != null) {
          htmlOut += "<div class = 'one_message'> <div class='avatar-box'><img class='avatar' src='" + response[i].pic + "'></div> <strong>" + response[i].name + ": </strong>" + response[i].text + "<br><a href='" + response[i].image + "'><img width='150px' height='auto' src='" + response[i].image + "'></a><br><div align='right'><em>" + response[i].like_count + " favorites</em></div></div>";
        //Case 4: Bad things happened.
        } else {
          console.log("Something went wrong with a message.");
        }
      }

      $("#lots_of_messages").append(htmlOut);
    });
    return false;
  }

  window.onload = function() {
    retrieveGroups();
    setTimeout(function(){retrieveMessages()}, 750);
    setTimeout(function(){$('#' + activeGroup).addClass('active');}, 1000);
  }

</script>

</head>

<body>
    <div class= "page-header" id="titleBar">
      <h1>Codename: KND</h1>
    </div>
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="col-md-3" id="groupsList">
                <!--List of Messages-->

                <h3>Groups</h3>
                <center>

                <form action="" method="" onSubmit="return false">
                  <input type="submit" value="Refresh Groups" onClick="retrieveGroups()"><br>
                  <div id="content"></div>
                </form>
              </center>
            </div>

            <div class="col-md-5" id="currConversation">
                <!--Body content of Open Message-->

                <h3></h3>
                <input id="messageContent" type="text" placeholder="Enter a message">
                <button id="send-message" class="btn" type="button" onclick="sendMessage()">Send</button>
                <div id="lots_of_messages"></div>
                <center>
                <button id="load_more" class="btn" type="button" onclick="loadMore()">Load More Messages</button>
                </center>
            </div>

            <div class="col-md-3" id="metricsPane">
                <!--Metrics and search engine-->

                <h3>Search</h3>

                <form class="form-search">
                    <input class="input-medium search-query" type="text">
                    <button class="btn" type="submit">Search</button>
                </form>
            </div>
        </div>
    </div><br>
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
</body>
</html>