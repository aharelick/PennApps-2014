<!DOCTYPE html>

<html lang="en">
<head>
  <link href=
    "//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="../stylesheets/style.css">

<script type="text/javascript">

  var activeGroup;

  function retrieveGroups() {
    $.getJSON('/groupme/groups', function(elements) {
      console.log(elements);
      console.log(elements.length);
      if (elements != undefined) {
        var htmlOut = "";
        for (var i=0; i<elements.length; i++) {
          htmlOut += "<div class='conversationBox' id='" + elements[i].id + "'onClick='makeActive(" + elements[i].id + ")'>" + elements[i].conversationName + "</div>";
        }
        $("#content").html(htmlOut);
      } else {
        var htmlOut = "No conversations found."
        $("#content").html(htmlOut);
      }
    });
  }

  function makeActive(i) {
    $('#' + activeGroup).removeClass('active');
    activeGroup = i;
    $('#' + activeGroup).addClass('active');
    console.log(activeGroup);
    retrieveMessages();
  }

  function checkActive() {
    return activeGroup;
  }

  function sendMessage() {
    if (activeGroup != null) {
      var content = $("#messageContent").val();
      var id = activeGroup; //fix this jawn
      var data = {message: content, group_id: id};
      $.ajax({
        type: "POST",
        url: 'http://localhost:3000/groupme/send/',
        data: data
      });
      console.log('it happened');
      $("#messageContent").val("");
      setTimeout(function(){retrieveMessages()}, 75);
    } else {
      console.log("Pick a conversation.");
    }
    return false;
  }

  function retrieveMessages() {
    var id = activeGroup;
    var data = {group_id: id};
    $.get('http://localhost:3000/groupme/messages?group_id=' + id, function(response) {
      console.log(response);
      var htmlOut = "";
      for (var i = 0; i < response.length; i++) {
        htmlOut += "<div class = 'one_message'> <div class='avatar'><img class='avatar' src='" + response[i].pic + "'></div> <strong>" + response[i].name + ": </strong>" + response[i].text + "<br><div align='right'><em>" + response[i].like_count + " favorites</em></div></div>";
      }
      $("#lots_of_messages").html(htmlOut);
    });
    return false;
  }
</script>

</head>

<body>
    <div class= "page-header" id="titleBar">
      <h1>Codename: KND</h1>
    </div>
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="col-md-3" id="groupsList">
                <!--List of Messages-->

                <h3>List of Conversations</h3>
                <center>

                <form action="" method="" onSubmit="return false">
                  <input type="submit" value="Retrieve Groups" onClick="retrieveGroups()"><br>
                  <div id="content"></div>
                </form>
              </center>
            </div>

            <div class="col-md-5" id="currConversation">
                <!--Body content of Open Message-->

                <h3>Active Conversation</h3>
                <input id="messageContent" type="text" placeholder="Enter a message">
                <button id="send-message" class="btn" type="button" onclick="sendMessage()">Send</button>
                <div id="lots_of_messages"></div>

            </div>

            <div class="col-md-3" id="metricsPane">
                <!--Metrics and search engine-->

                <h3>Search</h3>

                <form class="form-search">
                    <input class="input-medium search-query" type="text">
                    <button class="btn" type="submit">Search</button>
                </form>
            </div>
        </div>
    </div><br>
    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
</body>
</html>